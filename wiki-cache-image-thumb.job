#!/bin/bash

set -e
set -x
url=$1
md5=$2
mkdir -p "`dirname $md5`"
seq=`random 20`; ((seq = (seq + $$ % 19) % 20)); 
(
    flock 200
    test -e "$md5".url && test -e "$md5" && exit
    tsocks wget "$url" -O "$md5".$$.tmp -o /dev/null
    mv "$md5".$$.tmp "$md5"
    echo "$url" > "$md5".url
) 200>~/.wiki-cache-image-thumb$seq.lock
