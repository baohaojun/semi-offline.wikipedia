#!/bin/bash

set -e
set -x
url=$1
md5=$2
mkdir -p "`dirname $md5`"
seq=`echo $md5|md5sum|pn 1`
seq=`printf %d 0x"${seq:0:2}"`
((seq = seq % 20))
(
    flock 200
    test -e "$md5".url && test -e "$md5" && exit
    tsocks wget "$url" -O "$md5".$$.tmp -o /dev/null
    mv "$md5".$$.tmp "$md5"
    echo "$url" > "$md5".url
) 200>~/.wiki-cache-image-thumb$seq.lock
